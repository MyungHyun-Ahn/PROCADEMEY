#pragma once

struct DebugInfo
{
	// Push 0
	// Pop 1
	USHORT pushOrPop;
	USHORT pushSuccess;
	USHORT threadId;
	USHORT data;
	void *Head;
	void *HeadNext;
	void *Tail;
	void *TailNext;
};

extern DebugInfo logging[200000];
extern LONG64 logIndex;

template<typename Data>
struct QNode
{
	Data data;
	QNode *next;
};

template<typename T>
class LFQueue
{
public:
	LFQueue()
	{
		m_Size = 0;
		m_Head = new QNode<T>;
		m_Head->next = NULL;
		m_Tail = m_Head;
	}

	void Enqueue(T t)
	{
		QNode<T> *node = new QNode<T>;
		node->data = t;
		node->next = NULL;

		while (true)
		{
			QNode<T> *tail = m_Tail;
			QNode<T> *next = tail->next;

			if (InterlockedCompareExchangePointer((PVOID *)&tail->next, node, next) == next)
			{
				// 이런 상황이 발생
				if (InterlockedCompareExchangePointer((PVOID *)&m_Tail, node, tail) != tail) // 실패의 경우 그 이유 추적 - 사실 실패해도 상관 없다.
				{
					LONG64 backUp = InterlockedIncrement64(&logIndex);
					QNode<T> *head = m_Head;
					QNode<T> *headNext = head->next;
					logging[backUp % 200000] = { 0, 1, (USHORT)GetCurrentThreadId(), (USHORT)node->data, head, headNext, tail, next };

					// __debugbreak();
					break;
				}

				LONG64 backUp = InterlockedIncrement64(&logIndex);
				QNode<T> *head = m_Head;
				QNode<T> *headNext = head->next;
				logging[backUp % 200000] = { 0, 0, (USHORT)GetCurrentThreadId(), (USHORT)node->data, head, headNext, tail, next };

				USHORT myThId = (USHORT)GetCurrentThreadId();

				// 성공했는데 m_Tail->next가 NULL이 아닌 상황
				if (m_Tail->next != NULL)
					__debugbreak();

				break;
			}
		}

		InterlockedExchangeAdd(&m_Size, 1);
	}

	int Dequeue(T *t)
	{
		if (InterlockedDecrement(&m_Size) < 0)
			return InterlockedIncrement(&m_Size);

		while (true)
		{
			QNode<T> *head = m_Head;
			QNode<T> *next = head->next;

			if (next == NULL)
			{
				return -1;
			}
			else
			{
				if (InterlockedCompareExchangePointer((PVOID *)&m_Head, next, head) == head)
				{
					*t = next->data;
					QNode<T> *backHead = m_Head;
					QNode<T> *backNext = backHead->next;

					LONG64 backUp = InterlockedIncrement64(&logIndex);
					QNode<T> *tail = m_Tail;
					QNode<T> *tailNext = tail->next;
					logging[backUp % 200000] = { 1, 0, (USHORT)GetCurrentThreadId(), (USHORT)next->data, backHead, backNext, tail, tailNext };

					delete head;
				}
			}
		}

		return 0;
	}

private:
	LONG m_Size;
	QNode<T> *m_Head;
	QNode<T> *m_Tail;
};

/*
00 00 // 00 00 // 1c 6b // 02 00 // 00 a3 24 01 e0 01 00 00 // 60 a1 24 01 e0 01 00 00 // a0 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...`?$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 00 00 // 60 a1 24 01 e0 01 00 00 // 20 a4 24 01 e0 01 00 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`?$.?... ?$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 00 00 // 20 a4 24 01 e0 01 00 00 // e0 a3 24 01 e0 01 00 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k.. ?$.?...??$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 01 00 // e0 a3 24 01 e0 01 00 00 // a0 a1 24 01 e0 01 00 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...??$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 01 00 // a0 a1 24 01 e0 01 00 00 // a0 a4 24 01 e0 01 00 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...??$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 02 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // a0 a4 24 01 e0 01 00 00 // 40 a4 24 01 e0 01 00 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...@?$.?...??$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // a0 a4 24 01 e0 01 00 00 // 40 a4 24 01 e0 01 00 00 // 40 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...@?$.?...@?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // a0 a4 24 01 e0 01 00 00 // 40 a4 24 01 e0 01 00 00 // 80 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...@?$.?....?$.?...........
01 00 // 00 00 // 1c 6b // 00 00 // 40 a4 24 01 e0 01 00 00 // 80 a1 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..@?$.?....?$.?...`?$.?...........
01 00 // 00 00 // 1c 6b // 01 00 // 80 a1 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...`?$.?...`?$.?...........
01 00 // 00 00 // 1c 6b // 02 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`?$.?...........`?$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 60 a2 24 01 e0 01 00 00 // 80 a2 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`?$.?....?$.?...`?$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 60 a2 24 01 e0 01 00 00 // 80 a2 24 01 e0 01 00 00 // 80 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`?$.?....?$.?....?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 60 a2 24 01 e0 01 00 00 // 80 a2 24 01 e0 01 00 00 // c0 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`?$.?....?$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 00 00 // 80 a2 24 01 e0 01 00 00 // c0 a2 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...??$.?....?$.?...........
01 00 // 00 00 // 1c 6b // 01 00 // c0 a2 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?....?$.?....?$.?...........
01 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?............?$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // c0 a2 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...??$.?....?$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // c0 a2 24 01 e0 01 00 00 // c0 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...??$.?...??$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // c0 a2 24 01 e0 01 00 00 // 40 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...??$.?...@?$.?...........
01 00 // 00 00 // 1c 6b // 00 00 // c0 a2 24 01 e0 01 00 00 // 40 a3 24 01 e0 01 00 00 // 00 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...@?$.?....?$.?...........
01 00 // 00 00 // 1c 6b // 01 00 // 40 a3 24 01 e0 01 00 00 // 00 a3 24 01 e0 01 00 00 // 00 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..@?$.?....?$.?....?$.?...........
01 00 // 00 00 // 1c 6b // 02 00 // 00 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 00 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?............?$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 00 a3 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 00 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?....?$.?....?$.?...........
// 이때 80 a4 24 01 e0 01 00 00
00 00 // 00 00 // 1c 6b // 01 00 // 00 a3 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?....?$.?....?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 00 a3 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?....?$.?...`?$.?...........
01 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // e0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...`?$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 01 00 // 60 a2 24 01 e0 01 00 00 // e0 a3 24 01 e0 01 00 00 // e0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`?$.?...??$.?...??$.?...........
01 00 // 00 00 // 1c 6b // 02 00 // e0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // e0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?...........??$.?...........

// e0 a3 24 01 e0 01 00 00 push
00 00 // 00 00 // cc 62 // 02 00 // e0 a3 24 01 e0 01 00 00 // 60 1d 25 01 e0 01 00 00 // e0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  ....?b..??$.?...`.%.?...??$.?...........


01 00 // 00 00 // 1c 6b // 02 00 // 60 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 60 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`.%.?...........`.%.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 60 1d 25 01 e0 01 00 00 // a0 a3 24 01 e0 01 00 00 // 60 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`.%.?...??$.?...`.%.?...........
00 00 // 00 00 // cc 62 // 00 00 // 60 1d 25 01 e0 01 00 00 // a0 a3 24 01 e0 01 00 00 // a0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  ....?b..`.%.?...??$.?...??$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 60 1d 25 01 e0 01 00 00 // a0 a3 24 01 e0 01 00 00 // 20 1e 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..`.%.?...??$.?... .%.?...........
00 00 // 00 00 // cc 62 // 01 00 // 60 1d 25 01 e0 01 00 00 // a0 a3 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  ....?b..`.%.?...??$.?...`?$.?...........

CAS 2 실패
00 00 // 01 00 // 1c 6b // 02 00 // 60 1d 25 01 e0 01 00 00 // a0 a3 24 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // 80 1d 25 01 e0 01 00 00  .....k..`.%.?...??$.?...`?$.?.....%.?...
01 00 // 00 00 // 1c 6b // 00 00 // a0 a3 24 01 e0 01 00 00 // 20 1e 25 01 e0 01 00 00 // 80 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k..??$.?... .%.?.....%.?...........

// 얘가 먼저 바꿔버림
00 00 // 00 00 // cc 62 // 02 00 // a0 a3 24 01 e0 01 00 00 // 20 1e 25 01 e0 01 00 00 // 80 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  ....?b..??$.?... .%.?.....%.?...........
01 00 // 00 00 // 1c 6b // 00 00 // 20 1e 25 01 e0 01 00 00 // 60 a2 24 01 e0 01 00 00 // a0 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k.. .%.?...`?$.?...?.%.?...........

// Tail과 Head가 안맞는 상황 발생
01 00 // 00 00 // cc 62 // 01 00 // 60 a2 24 01 e0 01 00 00 // 80 a4 24 01 e0 01 00 00 // a0 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  ....?b..`?$.?....?$.?...?.%.?...........
01 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // a0 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?.%.?...........

// head->next가 null인데 계속 삽입하는 상황 발생
// 얘가 CAS 2 잘못 성공
// 비어있을 때 m_Head와 m_Tail이 같은 포인터를 가리켜야 하는데 다른 녀석을 가리키게 됨
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // a0 1d 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?.%.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 40 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........@?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 80 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?............?$.?...........
00 00 // 00 00 // cc 62 // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // a0 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  ....?b...?$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 80 1e 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?.............%.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // a0 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 60 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........`?$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // c0 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 60 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........`?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 80 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?............?$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // c0 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 40 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........@?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // a0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // e0 a1 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 40 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........@?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 60 a2 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........`?$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 00 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?............?$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // e0 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........??$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 20 a3 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?........... ?$.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 00 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?............?$.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 20 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?........... ?$.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // b0 25 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?%%.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 50 26 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........P&%.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 90 25 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?%%.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // f0 23 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?#%.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // d0 26 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?&%.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // d0 25 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?%%.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // f0 25 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........?%%.?...........
00 00 // 00 00 // 1c 6b // 00 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 50 23 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........P#%.?...........
00 00 // 00 00 // 1c 6b // 01 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 10 24 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?............$%.?...........
00 00 // 00 00 // 1c 6b // 02 00 // 80 a4 24 01 e0 01 00 00 // 00 00 00 00 00 00 00 00 // 70 23 25 01 e0 01 00 00 // 00 00 00 00 00 00 00 00  .....k...?$.?...........p#%.?...........
*/